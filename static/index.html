<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ—¥å†åŠ©æ‰‹</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Segoe UI", Roboto, sans-serif;
        }
        body {
            display: grid;
            grid-template-columns: 350px 1fr;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            gap: 10px;
            padding: 10px;
            background-color: #f5f5f7;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .header {
            grid-column: 1 / 3;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header h1 {
            color: #1a73e8;
            font-size: 1.5rem;
        }

        /* å¯¹è¯æ¡†åŒºåŸŸ */
        .chat-container {
            grid-row: 2 / 3;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }
        .message {
            margin: 8px 0;
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.4;
        }
        .user-message {
            background-color: #1a73e8;
            color: white;
            margin-left: auto;
        }
        .agent-message {
            background-color: #e5e5ea;
            color: #000;
            margin-right: auto;
        }
        .chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #eee;
        }
        .chat-input input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
            font-size: 1rem;
        }
        .chat-input button {
            margin-left: 10px;
            padding: 10px 20px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }
        .chat-input button:hover {
            background-color: #0d66d0;
        }

        /* æ—¥å†åŒºåŸŸ */
        .calendar-container {
            grid-row: 2 / 3;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .nav-button {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            font-size: 1rem;
        }
        .nav-button:hover {
            background-color: #f0f7ff;
        }
        .view-buttons button {
            padding: 6px 12px;
            margin-left: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
        }
        .view-buttons button.active {
            background-color: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }
        .current-date {
            font-size: 1.2rem;
            font-weight: 500;
        }

        /* æœˆå†è§†å›¾ */
        .month-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            flex: 1;
        }
        .weekday {
            text-align: center;
            font-weight: 500;
            color: #666;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .day-cell {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 5px;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            border: 1px solid #f0f0f0;
            min-height: 80px;
        }
        .day-cell:hover {
            background-color: #f0f7ff;
        }
        .day-cell.today {
            background-color: #e8f0fe;
            border: 2px solid #1a73e8;
        }
        .day-cell.other-month {
            color: #ccc;
            background-color: #fafafa;
        }
        .day-number {
            font-weight: 500;
            margin-bottom: 5px;
        }
        .day-events {
            width: 100%;
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .event-item {
            font-size: 0.7rem;
            padding: 2px 4px;
            background-color: #1a73e8;
            color: white;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .event-item.orange {
            background-color: #f57c00;
        }
        .event-item.green {
            background-color: #34a853;
        }
        .event-item.purple {
            background-color: #9c27b0;
        }
        .event-more {
            font-size: 0.7rem;
            color: #666;
            text-align: center;
            margin-top: 2px;
        }

        /* æ—¥è§†å›¾ */
        .day-view {
            display: none;
            flex-direction: column;
            height: 100%;
        }
        .day-events-list {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
            overflow-y: auto;
        }
        .day-event {
            padding: 10px 15px;
            border-left: 4px solid #1a73e8;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .event-time {
            font-weight: 500;
            color: #1a73e8;
        }
        .event-title {
            margin-top: 5px;
            font-size: 1rem;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="header">
        <h1>AI æ—¥å†åŠ©æ‰‹</h1>
    </div>

    <!-- å¯¹è¯æ¡†åŒºåŸŸ -->
    <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <div class="message agent-message">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„æ—¥å†åŠ©æ‰‹ï¼Œå¯ä»¥å¸®ä½ ç®¡ç†æ—¥ç¨‹ã€‚è¯·é—®æœ‰ä»€ä¹ˆéœ€è¦ï¼Ÿ</div>
        </div>
        <div class="chat-input">
            <input type="text" id="userInput" placeholder="è¾“å…¥ä½ çš„éœ€æ±‚...">
            <button onclick="sendMessage()">å‘é€</button>
        </div>
    </div>

    <!-- æ—¥å†åŒºåŸŸ -->
    <div class="calendar-container">
        <div class="calendar-header">
            <div class="calendar-nav">
                <button class="nav-button" onclick="changeMonth(-1)">â† ä¸Šä¸ªæœˆ</button>
                <div class="current-date" id="currentDate">2024å¹´6æœˆ</div>
                <button class="nav-button" onclick="changeMonth(1)">ä¸‹ä¸ªæœˆ â†’</button>
            </div>
            <div class="view-buttons">
                <button class="active" id="monthViewBtn" onclick="switchView('month')">æœˆè§†å›¾</button>
                <button id="dayViewBtn" onclick="switchView('day')">æ—¥è§†å›¾</button>
            </div>
        </div>

        <!-- æœˆå†è§†å›¾ -->
        <div class="month-view" id="monthView">
            <!-- æ˜ŸæœŸæ ‡é¢˜ -->
            <div class="weekday">æ—¥</div>
            <div class="weekday">ä¸€</div>
            <div class="weekday">äºŒ</div>
            <div class="weekday">ä¸‰</div>
            <div class="weekday">å››</div>
            <div class="weekday">äº”</div>
            <div class="weekday">å…­</div>

            <!-- æ—¥æœŸå•å…ƒæ ¼ï¼ˆç”±JSåŠ¨æ€ç”Ÿæˆï¼‰ -->
        </div>

        <!-- æ—¥è§†å›¾ -->
        <div class="day-view" id="dayView">
            <div class="day-events-list" id="dayEventsList">
                <!-- æ—¥ç¨‹ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script>
        // å½“å‰è§†å›¾çŠ¶æ€ï¼ˆmonth/dayï¼‰
        let currentView = 'month';
        // å½“å‰æ˜¾ç¤ºçš„æœˆä»½
        let currentMonth = new Date();
        // å½“å‰é€‰ä¸­çš„æ—¥æœŸ
        let selectedDate = new Date();

        // åˆå§‹åŒ–é¡µé¢
        window.onload = function() {
            renderMonthView();
            document.getElementById('userInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
        };

        // åˆ‡æ¢æœˆä»½
        function changeMonth(direction) {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + direction, 1);
            renderMonthView();
        }

        // åˆ‡æ¢è§†å›¾ï¼ˆæœˆè§†å›¾/æ—¥è§†å›¾ï¼‰
        function switchView(view) {
            currentView = view;
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('monthViewBtn').classList.toggle('active', view === 'month');
            document.getElementById('dayViewBtn').classList.toggle('active', view === 'day');
            // æ˜¾ç¤ºå¯¹åº”è§†å›¾
            document.getElementById('monthView').style.display = view === 'month' ? 'grid' : 'none';
            document.getElementById('dayView').style.display = view === 'day' ? 'flex' : 'none';

            if (view === 'day') {
                renderDayView(selectedDate);
            }
        }

        // æ¸²æŸ“æœˆå†è§†å›¾
        function renderMonthView() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            document.getElementById('currentDate').textContent = `${year}å¹´${month+1}æœˆ`;

            const monthView = document.getElementById('monthView');
            // æ¸…ç©ºåŸæœ‰æ—¥æœŸï¼ˆä¿ç•™æ˜ŸæœŸæ ‡é¢˜ï¼‰
            while (monthView.children.length > 7) {
                monthView.removeChild(monthView.lastChild);
            }

            // è·å–å½“æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡ ï¼ˆ0-6ï¼Œ0æ˜¯å‘¨æ—¥ï¼‰
            const firstDay = new Date(year, month, 1).getDay();
            // è·å–å½“æœˆå¤©æ•°
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            // è·å–ä¸Šä¸ªæœˆçš„å¤©æ•°
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            // æ·»åŠ ä¸Šæœˆçš„æ—¥æœŸï¼ˆç°è‰²æ˜¾ç¤ºï¼‰
            for (let i = firstDay - 1; i >= 0; i--) {
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell other-month';
                const day = daysInPrevMonth - i;
                dayCell.innerHTML = `
                    <div class="day-number">${day}</div>
                    <div class="day-events" id="events-${year}-${month}-${day}"></div>
                `;
                monthView.appendChild(dayCell);
            }

            // æ·»åŠ å½“æœˆæ—¥æœŸ
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell';
                dayCell.innerHTML = `
                    <div class="day-number">${day}</div>
                    <div class="day-events" id="events-${year}-${month+1}-${day}"></div>
                `;

                // æ ‡è®°ä»Šå¤©
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayCell.classList.add('today');
                }

                // ç‚¹å‡»æ—¥æœŸåˆ‡æ¢åˆ°æ—¥è§†å›¾
                dayCell.onclick = () => {
                    selectedDate = new Date(year, month, day);
                    switchView('day');
                };

                monthView.appendChild(dayCell);

                // åŠ è½½å½“å¤©çš„äº‹ä»¶
                loadDayEventsForMonthView(year, month+1, day);
            }

            // æ·»åŠ ä¸‹ä¸ªæœˆçš„æ—¥æœŸï¼ˆç°è‰²æ˜¾ç¤ºï¼‰
            const totalCells = 42; // 6è¡ŒÃ—7åˆ—
            const remainingCells = totalCells - (firstDay + daysInMonth);
            for (let day = 1; day <= remainingCells; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell other-month';
                dayCell.innerHTML = `
                    <div class="day-number">${day}</div>
                    <div class="day-events" id="events-${year}-${month+2}-${day}"></div>
                `;
                monthView.appendChild(dayCell);
            }
        }

        // ä¸ºæœˆå†è§†å›¾åŠ è½½æŸå¤©çš„äº‹ä»¶
        async function loadDayEventsForMonthView(year, month, day) {
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const eventsContainer = document.getElementById(`events-${year}-${month}-${day}`);

            if (!eventsContainer) return;

            // æ˜¾ç¤ºåŠ è½½ä¸­
            eventsContainer.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                // ğŸ› ï¸ ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„APIç«¯ç‚¹
                const response = await fetch('/api/day-schedule', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({date: dateStr})
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                eventsContainer.innerHTML = '';

                // ğŸ› ï¸ ä¿®å¤ï¼šæ£€æŸ¥æ•°æ®æ ¼å¼
                const events = data.events || [];

                // æ˜¾ç¤ºæœ€å¤š3ä¸ªäº‹ä»¶
                const eventsToShow = events.slice(0, 3);
                const colorClasses = ['', 'orange', 'green', 'purple'];

                eventsToShow.forEach((event, index) => {
                    const eventEl = document.createElement('div');
                    eventEl.className = `event-item ${colorClasses[index] || ''}`;
                    const startTime = new Date(event.start_time);
                    const timeStr = `${startTime.getHours()}:${String(startTime.getMinutes()).padStart(2, '0')}`;
                    eventEl.title = `${event.title} - ${timeStr}`;
                    eventEl.textContent = event.title;
                    eventsContainer.appendChild(eventEl);
                });

                // å¦‚æœè¿˜æœ‰æ›´å¤šäº‹ä»¶ï¼Œæ˜¾ç¤ºæç¤º
                if (events.length > 3) {
                    const moreEl = document.createElement('div');
                    moreEl.className = 'event-more';
                    moreEl.textContent = `è¿˜æœ‰ ${events.length - 3} ä¸ªäº‹ä»¶...`;
                    eventsContainer.appendChild(moreEl);
                }

                // å¦‚æœæ²¡æœ‰äº‹ä»¶ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
                if (events.length === 0) {
                    eventsContainer.innerHTML = '';
                }

            } catch (e) {
                console.error('åŠ è½½äº‹ä»¶å¤±è´¥:', e);
                eventsContainer.innerHTML = '<div class="event-more">åŠ è½½å¤±è´¥</div>';
            }
        }

        // æ¸²æŸ“æ—¥è§†å›¾
        async function renderDayView(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            document.getElementById('currentDate').textContent = `${year}å¹´${month}æœˆ${day}æ—¥`;

            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const eventsList = document.getElementById('dayEventsList');
            eventsList.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                // ğŸ› ï¸ ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„APIç«¯ç‚¹
                const response = await fetch('/api/day-schedule', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({date: dateStr})
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                eventsList.innerHTML = '';

                // ğŸ› ï¸ ä¿®å¤ï¼šæ£€æŸ¥æ•°æ®æ ¼å¼
                const events = data.events || [];

                if (events.length === 0) {
                    eventsList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">ä»Šå¤©æ²¡æœ‰å®‰æ’</div>';
                    return;
                }

                // æŒ‰æ—¶é—´æ’åºäº‹ä»¶
                events.sort((a, b) => new Date(a.start_time) - new Date(b.start_time));

                // æ¸²æŸ“äº‹ä»¶
                events.forEach(event => {
                    const start = new Date(event.start_time);
                    const end = new Date(event.end_time);
                    const timeStr = `${start.getHours().toString().padStart(2, '0')}:${start.getMinutes().toString().padStart(2, '0')} - ${end.getHours().toString().padStart(2, '0')}:${end.getMinutes().toString().padStart(2, '0')}`;

                    const eventEl = document.createElement('div');
                    eventEl.className = 'day-event';
                    eventEl.innerHTML = `
                        <div class="event-time">${timeStr}</div>
                        <div class="event-title">${event.title}</div>
                        ${event.location ? `<div class="event-location">ğŸ“ ${event.location}</div>` : ''}
                        ${event.description ? `<div class="event-description" style="margin-top: 5px; color: #666; font-size: 0.9rem;">${event.description}</div>` : ''}
                    `;
                    eventsList.appendChild(eventEl);
                });
            } catch (e) {
                console.error('åŠ è½½æ—¥è§†å›¾äº‹ä»¶å¤±è´¥:', e);
                eventsList.innerHTML = '<div style="text-align: center; padding: 20px; color: #ff0000;">åŠ è½½å¤±è´¥: ' + e.message + '</div>';
            }
        }

        // å‘é€æ¶ˆæ¯åˆ°åç«¯
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            if (!message) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML += `<div class="message user-message">${message}</div>`;
            input.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // è°ƒç”¨åç«¯API
            try {
                const response = await fetch('/api/message', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message: message})
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // æ·»åŠ AIå›å¤åˆ°ç•Œé¢
                chatMessages.innerHTML += `<div class="message agent-message">${data.response}</div>`;
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // åˆ·æ–°æ—¥å†è§†å›¾ï¼ˆå¦‚æœæœ‰æ–°äº‹ä»¶ï¼‰
                setTimeout(() => {
                    if (currentView === 'month') {
                        renderMonthView();
                    } else {
                        renderDayView(selectedDate);
                    }
                }, 500);

            } catch (e) {
                chatMessages.innerHTML += `<div class="message agent-message" style="color: red;">å‡ºé”™äº†: ${e.message}</div>`;
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
    </script>
</body>
</html>