<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ—¥ç¨‹ç®¡ç†åŠ©æ‰‹</title>
    <style>
        /* ====== åŸºç¡€æ ·å¼ RESET ====== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif;
        }
        :root {
            --primary: #1a73e8;
            --primary-soft: #e8f0fe;
            --bg: #f5f5f7;
            --card-bg: #ffffff;
            --border: #e0e0e0;
            --text-main: #202124;
            --text-sub: #5f6368;
            --danger: #d93025;
        }
        body {
            height: 100vh;
            background: radial-gradient(circle at top left, #e8f0fe 0, #f5f5f7 40%, #ffffff 100%);
            display: grid;
            grid-template-rows: 64px 1fr;
            grid-template-columns: minmax(320px, 430px) minmax(0, 1fr);
            gap: 12px;
            padding: 12px;
            color: var(--text-main);
        }

        /* ====== é¡¶éƒ¨å¯¼èˆª ====== */
        .header {
            grid-column: 1 / 3;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(16px);
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo-circle {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            background: linear-gradient(135deg, #1a73e8, #34a853);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
            font-size: 18px;
        }
        .header-title {
            display: flex;
            flex-direction: column;
        }
        .header-title h1 {
            font-size: 1.2rem;
            font-weight: 600;
        }
        .header-title span {
            font-size: 0.8rem;
            color: var(--text-sub);
        }
        .header-right {
            font-size: 0.8rem;
            color: var(--text-sub);
        }

        /* ====== Chat åŒºåŸŸ ====== */
        .chat-container {
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.96);
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .chat-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .chat-header-title {
            display: flex;
            flex-direction: column;
        }
        .chat-header-title span:first-child {
            font-size: 0.95rem;
            font-weight: 600;
        }
        .chat-header-title span:last-child {
            font-size: 0.8rem;
            color: var(--text-sub);
        }
        .chat-badges {
            display: flex;
            gap: 6px;
            font-size: 0.7rem;
        }
        .badge {
            padding: 2px 8px;
            border-radius: 999px;
            background-color: var(--primary-soft);
            color: var(--primary);
            border: 1px solid rgba(26, 115, 232, 0.2);
        }

        .chat-messages {
            flex: 1;
            padding: 12px 14px 10px 14px;
            overflow-y: auto;
            background: radial-gradient(circle at top, #f9fbff 0, #ffffff 60%);
        }

        .chat-message-row {
            display: flex;
            margin-bottom: 10px;
        }
        .chat-message-row.agent {
            justify-content: flex-start;
        }
        .chat-message-row.user {
            justify-content: flex-end;
        }
        .avatar {
            width: 28px;
            height: 28px;
            border-radius: 999px;
            background: var(--primary-soft);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            margin-right: 8px;
        }
        .chat-message-row.user .avatar {
            margin-right: 0;
            margin-left: 8px;
            background: #1a73e8;
            color: #ffffff;
        }
        .bubble-wrapper {
            max-width: 78%;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .bubble-meta {
            font-size: 0.7rem;
            color: var(--text-sub);
        }
        .bubble {
            padding: 8px 12px;
            border-radius: 16px;
            font-size: 0.9rem;
            line-height: 1.5;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        .bubble.agent {
            background-color: #f1f3f4;
            border-bottom-left-radius: 4px;
        }
        .bubble.user {
            background: linear-gradient(135deg, #1a73e8, #2563eb);
            color: #ffffff;
            border-bottom-right-radius: 4px;
        }

        /* typing indicator */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 6px;
            margin-bottom: 10px;
            color: var(--text-sub);
            font-size: 0.85rem;
        }
        .typing-dots {
            display: inline-flex;
            gap: 3px;
        }
        .typing-dots span {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: var(--text-sub);
            animation: blink 1.4s infinite both;
        }
        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes blink {
            0%, 80%, 100% { opacity: 0.3; transform: translateY(0); }
            40% { opacity: 1; transform: translateY(-2px); }
        }

        .chat-footer {
            border-top: 1px solid var(--border);
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: #fafafa;
        }
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .chip {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid #e0e0e0;
            background: #ffffff;
            cursor: pointer;
            color: var(--text-sub);
        }
        .chip:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-soft);
        }
        .chat-input-row {
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }
        .chat-input-box {
            flex: 1;
            position: relative;
        }
        #userInput {
            width: 100%;
            min-height: 38px;
            max-height: 90px;
            padding: 8px 12px;
            resize: none;
            border-radius: 999px;
            border: 1px solid #dadce0;
            outline: none;
            font-size: 0.9rem;
            line-height: 1.4;
            background: #ffffff;
        }
        #userInput:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 1px rgba(26, 115, 232, 0.12);
        }
        .input-hint {
            position: absolute;
            right: 12px;
            bottom: 6px;
            font-size: 0.7rem;
            color: var(--text-sub);
        }
        .send-btn {
            padding: 9px 16px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #1a73e8, #2563eb);
            color: #ffffff;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .send-btn:disabled {
            opacity: 0.6;
            cursor: default;
            box-shadow: none;
        }

        /* ====== æ—¥å†åŒºåŸŸ ====== */
        .calendar-container {
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.96);
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
            padding: 14px 16px 14px 16px;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .nav-button {
            padding: 5px 9px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: #ffffff;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .nav-button:hover {
            border-color: var(--primary);
            background: var(--primary-soft);
        }
        .current-date {
            font-size: 1rem;
            font-weight: 600;
        }
        .view-buttons {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .view-buttons button {
            padding: 5px 10px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: #ffffff;
            font-size: 0.8rem;
            cursor: pointer;
        }
        .view-buttons button.active {
            background: var(--primary);
            color: #ffffff;
            border-color: var(--primary);
        }

        .calendar-body {
            display: grid;
            grid-template-rows: auto minmax(0, 1fr);
            gap: 8px;
            flex: 1;
            min-height: 0;
        }

        /* æœˆå†è§†å›¾ */
        .month-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            border-radius: 12px;
            padding: 8px;
            background: #fafbff;
        }
        .weekday {
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-sub);
            padding-bottom: 4px;
            border-bottom: 1px solid #e0e7ff;
        }
        .day-cell {
            margin-top: 4px;
            aspect-ratio: 1;
            min-height: 70px;
            border-radius: 10px;
            background: #ffffff;
            border: 1px solid #edf0ff;
            padding: 4px;
            display: flex;
            flex-direction: column;
            position: relative;
            cursor: pointer;
            transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease;
        }
        .day-cell:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(148, 163, 184, 0.32);
            background: #f6f7ff;
        }
        .day-cell.today {
            border-width: 2px;
            border-color: var(--primary);
            background: #e8f0fe;
        }
        .day-cell.selected {
            outline: 2px solid #2563eb;
            outline-offset: -2px;
        }
        .day-cell.other-month {
            background: #fafafa;
            color: #bdbdbd;
        }
        .day-number-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
        }
        .day-number {
            font-size: 0.85rem;
            font-weight: 500;
        }
        .day-dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: var(--primary);
            opacity: 0;
            transition: opacity 0.15s;
        }
        .day-cell.has-events .day-dot {
            opacity: 1;
        }
        .day-events {
            width: 100%;
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .event-item {
            font-size: 0.7rem;
            padding: 2px 4px;
            border-radius: 4px;
            color: #ffffff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .event-item.blue {
            background: #1a73e8;
        }
        .event-item.orange {
            background-color: #f57c00;
        }
        .event-item.green {
            background-color: #34a853;
        }
        .event-item.purple {
            background-color: #9c27b0;
        }
        .event-more {
            font-size: 0.7rem;
            color: var(--text-sub);
            text-align: center;
            margin-top: 2px;
        }

        /* æ—¥è§†å›¾ï¼ˆå½“å¤©æ—¥ç¨‹åŒºï¼‰ */
        .day-view {
            border-radius: 12px;
            border: 1px solid #edf0ff;
            padding: 8px 10px;
            background: #f9fafb;
            display: flex;
            flex-direction: column;
            min-height: 110px;
        }
        .day-view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .day-view-header span:first-child {
            font-size: 0.9rem;
            font-weight: 600;
        }
        .day-view-header span:last-child {
            font-size: 0.8rem;
            color: var(--text-sub);
        }
        .day-events-list {
            flex: 1;
            margin-top: 4px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .day-event {
            background: #ffffff;
            border-radius: 10px;
            padding: 6px 10px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 6px rgba(148, 163, 184, 0.35);
            font-size: 0.85rem;
        }
        .event-time {
            font-weight: 600;
            color: var(--primary);
        }
        .event-title {
            margin-top: 2px;
        }
        .event-location {
            margin-top: 2px;
            font-size: 0.8rem;
            color: var(--text-sub);
        }
        .event-description {
            margin-top: 2px;
            font-size: 0.8rem;
            color: var(--text-sub);
        }
        .loading {
            text-align: center;
            padding: 12px;
            color: var(--text-sub);
            font-size: 0.85rem;
        }
        .ai-tag {
            display: inline-block;
            margin-top: 6px;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .ai-tag.fitness {
            background-color: #e0f3ff;
            color: #0077cc;
        }

        .ai-tag.conflict {
            background-color: #ffe8e6;
            color: #d93025;
        }


        /* ====== å“åº”å¼ ====== */
        @media (max-width: 900px) {
            body {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
                height: auto;
            }
            .header {
                grid-column: 1 / 2;
            }
            .chat-container {
                grid-column: 1 / 2;
                height: 60vh;
            }
            .calendar-container {
                grid-column: 1 / 2;
                min-height: 380px;
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="header">
        <div class="header-left">
            <div class="logo-circle">A</div>
            <div class="header-title">
                <h1>AI æ—¥ç¨‹ç®¡ç†åŠ©æ‰‹</h1>
                <span>è‡ªç„¶è¯­è¨€ â†’ ç»“æ„åŒ–æ—¥ç¨‹çš„æ™ºèƒ½ Agent æ¼”ç¤º</span>
            </div>
        </div>
        <div class="header-right" id="headerRight">
            <span id="headerDate"></span>
            <span style="margin:0 8px; color:#ccc;">|</span>

            <!-- Language Switch -->
            <span id="langZh" style="cursor:pointer; font-size:0.85rem; font-weight:500;">ä¸­æ–‡</span>
            <span style="margin: 0 4px;">/</span>
            <span id="langEn" style="cursor:pointer; font-size:0.85rem; font-weight:500;">English</span>
        </div>

    </header>

    <!-- Chat åŒºåŸŸ -->
    <section class="chat-container">
        <div class="chat-header">
            <div class="chat-header-title">
                <span>å¯¹è¯åŒº</span>
                <span>ç”¨ä¸­æ–‡ç›´æ¥æè¿°ä½ çš„è®¡åˆ’ï¼ŒAgent ä¼šå¸®ä½ ç”Ÿæˆæ—¥ç¨‹</span>
            </div>
            <div class="chat-badges">
                <div class="badge">NLP è§£æ</div>
                <div class="badge">æ—¥ç¨‹ç”Ÿæˆ</div>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <!-- åˆå§‹æ¬¢è¿è¯­ -->
        </div>

        <!-- åŠ©æ‰‹æ€è€ƒä¸­ -->
        <div class="typing-indicator" id="typingIndicator">
            <span style="font-size: 0.8rem;">åŠ©æ‰‹æ­£åœ¨æ€è€ƒ</span>
            <div class="typing-dots">
                <span></span><span></span><span></span>
            </div>
        </div>

        <div class="chat-footer">
            <div class="quick-actions">
                <button class="chip" data-quick="å¸®æˆ‘å®‰æ’ä¸€ä¸‹æ˜å¤©ä¸‹åˆä¸‰ç‚¹å’Œå¼ ä¸‰å¼€ä¼šã€‚">æ˜å¤©ä¸‹åˆä¸‰ç‚¹å’Œå¼ ä¸‰å¼€ä¼š</button>
                <button class="chip" data-quick="æŠŠä¸‹å‘¨ä¸€åˆ°å‘¨ä¸‰æ™šä¸Šä¸ƒç‚¹çš„æ—¶é—´éƒ½ç•™ç»™æœŸæœ«å¤ä¹ ã€‚">æœŸæœ«å¤ä¹ æ—¶é—´</button>
                <button class="chip" data-quick="å¸®æˆ‘çœ‹çœ‹è¿™å‘¨æœ‰æ²¡æœ‰ç©ºçš„æ™šä¸Šï¼Œå¯ä»¥è·‘æ­¥ã€‚">æŸ¥æ‰¾ç©ºé—²æ—¶é—´</button>
            </div>
            <div class="chat-input-row">
                <div class="chat-input-box">
                    <textarea id="userInput" placeholder="ä¾‹å¦‚ï¼šå¸®æˆ‘å®‰æ’æ˜å¤©ä¸Šåˆå¼€ä¸ªé¡¹ç›®è¿›åº¦ä¼šâ€¦" rows="1"></textarea>
                    <div class="input-hint">Enter å‘é€ Â· Shift+Enter æ¢è¡Œ</div>
                </div>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                    <span>å‘é€</span> <span>â¤</span>
                </button>
            </div>
        </div>
    </section>

    <!-- æ—¥å† + æ—¥ç¨‹åŒºåŸŸ -->
    <section class="calendar-container">
        <div class="calendar-header">
            <div class="calendar-nav">
                <button class="nav-button" onclick="changeMonth(-1)">â† ä¸Šä¸ªæœˆ</button>
                <div class="current-date" id="currentDate"></div>
                <button class="nav-button" onclick="changeMonth(1)">ä¸‹ä¸ªæœˆ â†’</button>
                <button class="nav-button" onclick="goToday()">å›åˆ°ä»Šå¤©</button>
            </div>
            <div class="view-buttons">
                <button class="active" id="monthViewBtn" onclick="switchView('month')">æœˆè§†å›¾</button>
                <button id="dayViewBtn" onclick="switchView('day')">ä»…çœ‹å½“å¤©æ—¥ç¨‹</button>
            </div>
        </div>

        <div class="calendar-body">
            <!-- æœˆè§†å›¾ -->
            <div class="month-view" id="monthView">
                <div class="weekday">æ—¥</div>
                <div class="weekday">ä¸€</div>
                <div class="weekday">äºŒ</div>
                <div class="weekday">ä¸‰</div>
                <div class="weekday">å››</div>
                <div class="weekday">äº”</div>
                <div class="weekday">å…­</div>
                <!-- æ—¥æœŸ cell ç”± JS æ³¨å…¥ -->
            </div>

            <!-- æ—¥è§†å›¾ï¼ˆå½“å¤©æ—¥ç¨‹ï¼‰ -->
            <div class="day-view" id="dayView">
                <div class="day-view-header">
                    <span id="dayViewTitle">ä»Šæ—¥å®‰æ’</span>
                    <span id="dayViewSubTitle"></span>
                </div>
                <div class="day-events-list" id="dayEventsList">
                    <!-- æ—¥ç¨‹ç”± JS æ¸²æŸ“ -->
                </div>
            </div>
        </div>
    </section>

    <script>
        // ====== å›½é™…åŒ–è¯­è¨€ç®¡ç† ======
        let currentLang = localStorage.getItem("lang") || "zh";

        // UI æ–‡æ¡ˆ
        const i18n = {
            badgeNLP: { zh: "NLP è§£æ", en: "NLP Parsing" },
            badgeCalendar: { zh: "æ—¥ç¨‹ç”Ÿæˆ", en: "Schedule Generation" },

            headerTitle: { zh: "AI æ—¥ç¨‹ç®¡ç†åŠ©æ‰‹", en: "AI Schedule Assistant" },
            headerSub: { zh: "è‡ªç„¶è¯­è¨€ â†’ ç»“æ„åŒ–æ—¥ç¨‹çš„æ™ºèƒ½ Agent æ¼”ç¤º", en: "Natural Language â†’ Structured Calendar AI Assistant" },

            chatTitle: { zh: "å¯¹è¯åŒº", en: "Chat Panel" },
            chatSub: { zh: "ç”¨ä¸­æ–‡ç›´æ¥æè¿°ä½ çš„è®¡åˆ’ï¼ŒAgent ä¼šå¸®ä½ ç”Ÿæˆæ—¥ç¨‹", en: "Describe your plan, and the agent will generate schedules." },

            send: { zh: "å‘é€", en: "Send" },

            monthView: { zh: "æœˆè§†å›¾", en: "Month" },
            dayView: { zh: "ä»…çœ‹å½“å¤©æ—¥ç¨‹", en: "Day View" },

            prevMonth: { zh: "â† ä¸Šä¸ªæœˆ", en: "â† Prev" },
            nextMonth: { zh: "ä¸‹ä¸ªæœˆ â†’", en: "Next â†’" },
            today: { zh: "å›åˆ°ä»Šå¤©", en: "Today" },

            aiThinking: { zh: "åŠ©æ‰‹æ­£åœ¨æ€è€ƒ", en: "Assistant is thinking" },

            // quick actions
            quick1: { zh: "æ˜å¤©ä¸‹åˆä¸‰ç‚¹å’Œå¼ ä¸‰å¼€ä¼š", en: "Meeting with John at 3 PM tomorrow" },
            quick2: { zh: "æœŸæœ«å¤ä¹ æ—¶é—´", en: "Exam review time" },
            quick3: { zh: "æŸ¥æ‰¾ç©ºé—²æ—¶é—´", en: "Find available times" },

            // placeholder
            inputPlaceholder: {
                zh: "ä¾‹å¦‚ï¼šå¸®æˆ‘å®‰æ’æ˜å¤©ä¸Šåˆå¼€ä¸ªé¡¹ç›®è¿›åº¦ä¼šâ€¦",
                en: "Example: Schedule a project meeting tomorrow morningâ€¦"
            },

            // åœ¨å³ä¾§æ—¥è§†å›¾çš„æ— äº‹ä»¶æç¤º
            noEventsToday: {
                zh: "ä»Šå¤©è¿˜æ²¡æœ‰å®‰æ’ï¼Œå¯ä»¥åœ¨å·¦ä¾§ç”¨è‡ªç„¶è¯­è¨€åˆ›å»ºä¸€ä¸ªæ—¥ç¨‹ã€‚",
                en: "No events today. You can create one from the chat panel."
            },

            // æ˜ŸæœŸ
            weekday: {
                zh: ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"],
                en: ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]
            },

            // æ¬¢è¿è¯­
            welcome: {
                zh:
        `ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„æ—¥ç¨‹ç®¡ç†åŠ©æ‰‹ã€‚

        ä½ å¯ä»¥ç”¨è‡ªç„¶è¯­è¨€æè¿°è®¡åˆ’ï¼Œæ¯”å¦‚ï¼š
        - â€œå¸®æˆ‘å®‰æ’æ˜å¤©ä¸‹åˆä¸‰ç‚¹å’Œå¼ ä¸‰å¼€ä¼šâ€
        - â€œä¸‹å‘¨ä¸€åˆ°å‘¨äº”æ¯å¤©æ™šä¸Šä¸ƒç‚¹æé†’æˆ‘å¤ä¹ æœºå™¨å­¦ä¹ â€

        æˆ‘ä¼šè§£æå¹¶å†™å…¥å³ä¾§æ—¥å†ï¼Œæ–¹ä¾¿ä½ åœ¨å±•ç¤ºæ—¶è¯´æ˜æ•´ä¸ª Agent æµç¨‹ã€‚`,
                en:
        `Hello, I'm your schedule assistant.

        You can describe your plans in natural language, for example:
        - â€œSchedule a meeting with John at 3 PM tomorrowâ€
        - â€œRemind me to study machine learning every evening next weekâ€

        I'll parse your instructions and write events into the calendar.`
            },

            // èŠå¤©æ—¶é—´ meta æ ‡ç­¾æ–‡æœ¬
            metaUser: { zh: "ä½  Â· ", en: "You Â· " },
            metaAgent: { zh: "åŠ©æ‰‹ Â· ", en: "AI Â· " },

            // agent è½»ç¿»è¯‘
            agentMap: {
                "äº‹ä»¶å·²æˆåŠŸæ·»åŠ ": "Event added successfully",
                "äº‹ä»¶å·²æˆåŠŸä¿®æ”¹": "Event modified successfully",
                "äº‹ä»¶å·²æˆåŠŸåˆ é™¤": "Event deleted successfully",
                "å½“å‰æ—¶é—´èŒƒå›´å†…æ²¡æœ‰äº‹ä»¶": "No events in this time range",
                "ä»Šå¤©è¿˜æ²¡æœ‰å®‰æ’": "No events today",
                "æ˜å¤©æ²¡æœ‰å®‰æ’äº‹ä»¶": "No events tomorrow",
                "æ“ä½œå·²å–æ¶ˆ": "Operation cancelled"
            }
        };


        function applyLanguage() {
            const t = i18n;
            
            // Badges
            const badges = document.querySelectorAll(".badge");
            badges[0].textContent = i18n.badgeNLP[currentLang];
            badges[1].textContent = i18n.badgeCalendar[currentLang];


            // Header
            document.querySelector(".header-title h1").textContent = t.headerTitle[currentLang];
            document.querySelector(".header-title span").textContent = t.headerSub[currentLang];

            // Chat title
            document.querySelector(".chat-header-title span:first-child").textContent = t.chatTitle[currentLang];
            document.querySelector(".chat-header-title span:last-child").textContent = t.chatSub[currentLang];

            // Send button
            document.querySelector("#sendBtn span").textContent = t.send[currentLang];

            // Quick actions
            const chips = document.querySelectorAll(".chip");
            chips[0].textContent = t.quick1[currentLang];
            chips[1].textContent = t.quick2[currentLang];
            chips[2].textContent = t.quick3[currentLang];

            // Placeholder
            document.getElementById("userInput").placeholder = t.inputPlaceholder[currentLang];

            // Nav buttons
            const nav = document.querySelectorAll(".nav-button");
            nav[0].textContent = t.prevMonth[currentLang];
            nav[1].textContent = t.nextMonth[currentLang];
            nav[2].textContent = t.today[currentLang];

            document.getElementById("monthViewBtn").textContent = t.monthView[currentLang];
            document.getElementById("dayViewBtn").textContent = t.dayView[currentLang];

            // Typing indicator
            document.querySelector("#typingIndicator span").textContent = t.aiThinking[currentLang];

            // Weekday headers
            document.querySelectorAll(".weekday").forEach((el, i) => {
                el.textContent = t.weekday[currentLang][i];
            });

            // Re-render date locale
            initHeaderDate();
        }


        // åˆ‡æ¢è¯­è¨€
        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem("lang", lang);

            applyLanguage();

            // ğŸ”¥ å¼ºåˆ¶åˆ·æ–°æœˆè§†å›¾ï¼ˆç”¨äºé¡¶éƒ¨æœˆä»½ã€æ˜ŸæœŸæ–‡å­—ç­‰ï¼‰
            renderMonthView();

            // ğŸ”¥ å¼ºåˆ¶åˆ·æ–°æ—¥è§†å›¾ï¼ˆç”¨äºâ€œä»Šæ—¥å®‰æ’â€ã€æ˜ŸæœŸã€æ— äº‹ä»¶æç¤ºï¼‰
            renderDayView(selectedDate);

            // ğŸ”¥ é‡æ–°æ¸²æŸ“æ¬¢è¿è¯­ï¼ˆè‹±æ–‡åˆ‡æ¢ä¾èµ–ï¼‰
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = "";
            appendMessage('agent', i18n.welcome[currentLang], false);
        }



        
        // ====== å…¨å±€çŠ¶æ€ ======
        let currentView = 'month';
        let currentMonth = new Date();
        let selectedDate = new Date();
        let isSending = false;

        window.onload = function () {
            initHeaderDate();
            initChatArea();
            renderMonthView();
            renderDayView(selectedDate);
            document.getElementById("langZh").onclick = () => setLanguage("zh");
            document.getElementById("langEn").onclick = () => setLanguage("en");

            // åˆæ¬¡æ¸²æŸ“
            applyLanguage();

        };

        function initHeaderDate() {
            const headerDate = document.getElementById('headerDate');
            const now = new Date();

            const zhWeek = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'];
            const enWeek = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

            if (currentLang === "zh") {
                headerDate.textContent =
                    `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ Â· ${zhWeek[now.getDay()]}`;
            } else {
                headerDate.textContent =
                    `${now.toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric'})} Â· ${enWeek[now.getDay()]}`;
            }
        }


        function initChatArea() {
            const chatMessages = document.getElementById('chatMessages');
            appendMessage('agent', i18n.welcome[currentLang], false);


            const input = document.getElementById('userInput');
            input.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            document.querySelectorAll('.chip[data-quick]').forEach(chip => {
                chip.addEventListener('click', () => {
                    input.value = chip.getAttribute('data-quick');
                    input.focus();
                });
            });
        }

        // ====== Chat ç›¸å…³ ======
        function appendMessage(role, text, animate = false) {
            const chatMessages = document.getElementById('chatMessages');
            const row = document.createElement('div');
            row.className = `chat-message-row ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = role === 'user' ? 'æˆ‘' : 'AI';

            const wrapper = document.createElement('div');
            wrapper.className = 'bubble-wrapper';

            const meta = document.createElement('div');
            meta.className = 'bubble-meta';
            const now = new Date();
            const timeStr = now.toTimeString().slice(0, 5);
            meta.textContent = (role === 'user' ? 'ä½  Â· ' : 'åŠ©æ‰‹ Â· ') + timeStr;

            const bubble = document.createElement('div');
            bubble.className = `bubble ${role}`;

            wrapper.appendChild(meta);
            wrapper.appendChild(bubble);

            // åœ¨ AI å›å¤åè¿½åŠ å¥èº«/å†²çªæç¤ºæ ‡ç­¾
            if (role === "agent") {
                const tagHtml = checkSpecialTags(text);
                if (tagHtml) {
                    const tagDiv = document.createElement('div');
                    tagDiv.innerHTML = tagHtml;
                    wrapper.appendChild(tagDiv);
                }
            }


            if (role === 'agent') {
                row.appendChild(avatar);
                row.appendChild(wrapper);
            } else {
                row.appendChild(wrapper);
                row.appendChild(avatar);
            }

            chatMessages.appendChild(row);
            scrollChatBottom();

            if (animate) {
                typeWriterEffect(bubble, text);
            } else {
                bubble.textContent = text;
                scrollChatBottom();
            }
        }

        function checkSpecialTags(text) {
            const tags = [];

            // å¥èº«è®¡åˆ’è¯†åˆ«ï¼ˆå¯è‡ªè¡Œæ‰©å±•ï¼‰
            const fitnessKeywords = ["å¥èº«", "è®­ç»ƒ", "åŠ›é‡è®­ç»ƒ", "è·‘æ­¥", "é”»ç‚¼", "è¿åŠ¨", "ç‘œä¼½"];
            if (fitnessKeywords.some(k => text.includes(k))) {
                tags.push(`<span class="ai-tag fitness">ğŸ‹ï¸ å¥èº«è®¡åˆ’å·²è¯†åˆ«</span>`);
            }

            // å†²çªæ£€æµ‹è¯†åˆ«
            const conflictKeywords = ["å†²çª", "æ—¶é—´æœ‰é‡å ", "å»ºè®®è°ƒæ•´", "å·²æœ‰å®‰æ’", "æ— æ³•å®‰æ’"];
            if (conflictKeywords.some(k => text.includes(k))) {
                tags.push(`<span class="ai-tag conflict">âš ï¸ æ—¶é—´å†²çªæç¤º</span>`);
            }

            return tags.join("<br>");
        }


        function scrollChatBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTyping() {
            const el = document.getElementById('typingIndicator');
            el.style.display = 'flex';
            scrollChatBottom();
        }
        function hideTyping() {
            const el = document.getElementById('typingIndicator');
            el.style.display = 'none';
        }

        function typeWriterEffect(el, text, speed = 15) {
            let index = 0;
            function step() {
                if (index <= text.length) {
                    el.textContent = text.slice(0, index);
                    index++;
                    scrollChatBottom();
                    setTimeout(step, speed);
                }
            }
            step();
        }

        async function sendMessage() {
            if (isSending) return;
            const input = document.getElementById('userInput');
            const btn = document.getElementById('sendBtn');
            const message = input.value.trim();
            if (!message) return;

            appendMessage('user', message, false);
            input.value = '';
            isSending = true;
            btn.disabled = true;
            showTyping();

            try {
                const response = await fetch('/api/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message, lang: currentLang })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                hideTyping();
                let agentText = data.response || "ï¼ˆåç«¯æœªè¿”å› response å­—æ®µï¼‰";

                if (currentLang === "en") {
                    // lightweight translation
                    for (const zh in i18n.agentMap) {
                        agentText = agentText.replace(zh, i18n.agentMap[zh]);
                    }
                }

                appendMessage('agent', agentText, true);


                // åˆ·æ–°å½“å‰è§†å›¾ï¼ˆæ–¹ä¾¿æ¼”ç¤ºï¼šAgent ä¸€æ—¦åˆ›å»ºäº†äº‹ä»¶ï¼Œå³ä¾§ç«‹åˆ»æ›´æ–°ï¼‰
                setTimeout(() => {
                    if (currentView === 'month') {
                        renderMonthView();
                    }
                    renderDayView(selectedDate);
                }, 350);
            } catch (e) {
                hideTyping();
                appendMessage('agent', 'å‡ºé”™äº†ï¼š' + e.message, false);
            } finally {
                isSending = false;
                btn.disabled = false;
            }
        }

        // ====== æ—¥å†è§†å›¾åˆ‡æ¢ ======
        function switchView(view) {
            currentView = view;
            document.getElementById('monthViewBtn').classList.toggle('active', view === 'month');
            document.getElementById('dayViewBtn').classList.toggle('active', view === 'day');

            const monthView = document.getElementById('monthView');
            const dayView = document.getElementById('dayView');
            monthView.style.display = view === 'month' ? 'grid' : 'none';
            // æ—¥è§†å›¾å®¹å™¨å§‹ç»ˆæ˜¾ç¤ºï¼Œåªæ˜¯æœˆè§†å›¾éšè—ä¸å¦
            renderDayView(selectedDate);
        }

        function changeMonth(direction) {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + direction, 1);
            renderMonthView();
        }

        function goToday() {
            currentMonth = new Date();
            selectedDate = new Date();
            renderMonthView();
            renderDayView(selectedDate);
        }

        // ====== æ¸²æŸ“æœˆè§†å›¾ ======
        function renderMonthView() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            if (currentLang === "zh") {
                document.getElementById('currentDate').textContent = `${year}å¹´${month + 1}æœˆ`;
            } else {
                const dateObj = new Date(year, month, 1);
                document.getElementById('currentDate').textContent =
                    dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
            }


            const monthView = document.getElementById('monthView');
            // ä¿ç•™å‰ 7 ä¸ªæ˜ŸæœŸæ ‡é¢˜
            while (monthView.children.length > 7) {
                monthView.removeChild(monthView.lastChild);
            }

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            // ä¸Šæœˆè¡¥ä½
            for (let i = firstDay - 1; i >= 0; i--) {
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell other-month';
                const day = daysInPrevMonth - i;
                dayCell.innerHTML = `
                    <div class="day-number-row">
                        <div class="day-number">${day}</div>
                        <div class="day-dot"></div>
                    </div>
                    <div class="day-events" id="events-${year}-${month}-${day}"></div>
                `;
                monthView.appendChild(dayCell);
            }

            const today = new Date();
            const selectedKey = `${selectedDate.getFullYear()}-${selectedDate.getMonth()}-${selectedDate.getDate()}`;

            // å½“å‰æœˆæ—¥æœŸ
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell';
                const key = `${year}-${month}-${day}`;

                dayCell.innerHTML = `
                    <div class="day-number-row">
                        <div class="day-number">${day}</div>
                        <div class="day-dot"></div>
                    </div>
                    <div class="day-events" id="events-${year}-${month + 1}-${day}"></div>
                `;

                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayCell.classList.add('today');
                }
                if (key === selectedKey) {
                    dayCell.classList.add('selected');
                }

                dayCell.onclick = () => {
                    selectedDate = new Date(year, month, day);
                    renderMonthView();
                    renderDayView(selectedDate);
                };

                monthView.appendChild(dayCell);
                loadDayEventsForMonthView(year, month + 1, day);
            }

            // ä¸‹æœˆè¡¥ä½åˆ° 6 è¡Œ
            const totalCells = 42;
            const usedCells = firstDay + daysInMonth;
            const remainingCells = totalCells - usedCells;
            for (let day = 1; day <= remainingCells; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell other-month';
                dayCell.innerHTML = `
                    <div class="day-number-row">
                        <div class="day-number">${day}</div>
                        <div class="day-dot"></div>
                    </div>
                    <div class="day-events" id="events-${year}-${month + 2}-${day}"></div>
                `;
                monthView.appendChild(dayCell);
            }
        }

        // ä¸ºæœˆè§†å›¾åŠ è½½æŸå¤©äº‹ä»¶ï¼ˆç®€ç•¥æ˜¾ç¤ºï¼‰
        async function loadDayEventsForMonthView(year, month, day) {
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const eventsContainer = document.getElementById(`events-${year}-${month}-${day}`);
            if (!eventsContainer) return;

            eventsContainer.innerHTML = '';
            try {
                const response = await fetch('/api/day-schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date: dateStr })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                const events = data.events || [];

                if (events.length === 0) {
                    const cell = eventsContainer.closest('.day-cell');
                    cell && cell.classList.remove('has-events');
                    return;
                }

                const cell = eventsContainer.closest('.day-cell');
                cell && cell.classList.add('has-events');

                const colorClasses = ['blue', 'orange', 'green', 'purple'];
                const toShow = events.slice(0, 2);
                toShow.forEach((event, index) => {
                    const el = document.createElement('div');
                    el.className = `event-item ${colorClasses[index % colorClasses.length]}`;
                    el.textContent = event.title || 'æœªå‘½åäº‹ä»¶';
                    eventsContainer.appendChild(el);
                });
                if (events.length > 2) {
                    const more = document.createElement('div');
                    more.className = 'event-more';
                    more.textContent = `+${events.length - 2}`;
                    eventsContainer.appendChild(more);
                }
            } catch (e) {
                eventsContainer.innerHTML = '';
            }
        }

        // ====== æ¸²æŸ“æ—¥è§†å›¾ï¼ˆå½“å¤©æ—¥ç¨‹ï¼‰ ======
        async function renderDayView(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();

            const zhWeek = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'];
            const enWeek = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

            const dayViewTitle = document.getElementById('dayViewTitle');
            const dayViewSub = document.getElementById('dayViewSubTitle');
            const eventsList = document.getElementById('dayEventsList');

            // ğŸ”¥ æ ¹æ®è¯­è¨€åˆ‡æ¢æ ‡é¢˜
            if (currentLang === "zh") {
                dayViewTitle.textContent = `${year}å¹´${month}æœˆ${day}æ—¥çš„æ—¥ç¨‹`;
                dayViewSub.textContent = zhWeek[date.getDay()];
            } else {
                const dateStr = date.toLocaleDateString('en-US', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
                dayViewTitle.textContent = `Schedule for ${dateStr}`;
                dayViewSub.textContent = enWeek[date.getDay()];
            }

            eventsList.innerHTML = 
                `<div class="loading">${currentLang === "zh" ? "åŠ è½½ä¸­â€¦" : "Loadingâ€¦"}</div>`;

            const requestDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

            try {
                const response = await fetch('/api/day-schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date: requestDate })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                const events = data.events || [];
                eventsList.innerHTML = '';

                // ğŸ”¥ æ— äº‹ä»¶ â€” æ”¯æŒä¸­è‹±æ–‡
                if (events.length === 0) {
                    eventsList.innerHTML =
                        `<div class="loading" style="color:#9ca3af;">
                            ${currentLang === "zh" 
                                ? "ä»Šå¤©è¿˜æ²¡æœ‰å®‰æ’ï¼Œå¯ä»¥åœ¨å·¦ä¾§ç”¨è‡ªç„¶è¯­è¨€åˆ›å»ºä¸€ä¸ªæ—¥ç¨‹ã€‚" 
                                : "No events today. You can create one from the chat panel."
                            }
                        </div>`;
                    return;
                }

                // æ’åº
                events.sort((a, b) => new Date(a.start_time) - new Date(b.start_time));

                // æ¸²æŸ“äº‹ä»¶
                events.forEach(event => {
                    const start = new Date(event.start_time);
                    const end = new Date(event.end_time);

                    const timeStr =
                        `${String(start.getHours()).padStart(2,'0')}:${String(start.getMinutes()).padStart(2,'0')} - ` +
                        `${String(end.getHours()).padStart(2,'0')}:${String(end.getMinutes()).padStart(2,'0')}`;

                    const el = document.createElement('div');
                    el.className = 'day-event';

                    el.innerHTML = `
                        <div class="event-time">${timeStr}</div>
                        <div class="event-title">${event.title || (currentLang === "zh" ? "æœªå‘½åäº‹ä»¶" : "Untitled event")}</div>
                        ${event.location ? `<div class="event-location">ğŸ“ ${event.location}</div>` : ''}
                        ${event.description ? `<div class="event-description">${event.description}</div>` : ''}
                    `;
                    eventsList.appendChild(el);
                });

            } catch (e) {
                eventsList.innerHTML =
                    `<div class="loading" style="color:var(--danger);">
                        ${currentLang === "zh" ? "åŠ è½½å¤±è´¥ï¼š" : "Failed to load: "} ${e.message}
                    </div>`;
            }
        }

    </script>
</body>
</html>
